## –ù–∞—á–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ - —Å–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞

–°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É —Å –ø—Ä–æ–µ–∫—Ç–æ–º –Ω–∞ –≥–∏—Ç—Ö–∞–±–µ. 

–î–æ–±–∞–≤–∏–ª –ø–∏—Ç–æ–Ω–æ–≤—Å–∫–∏–π gitignore –∏ MIT –ª–∏—Ü–µ–Ω–∑–∏—é.

<img width="882" height="789" alt="image" src="https://github.com/user-attachments/assets/a90678fa-88cc-4105-ae90-f6417be3525a" />

–°–æ–∑–¥–∞—é –ª–æ–∫–∞–ª—å–Ω—É—é –ø–∞–ø–∫—É –Ω–∞ —Å–≤–æ–µ–º –∫–æ–º–ø—å—é—Ç–µ—Ä–µ, –Ω–∞–ø—Ä–∏–º–µ—Ä `C:\Users\erohi\Desktop\de_project`

–û—Ç–∫—Ä—ã–≤–∞—é —Ç–µ—Ä–º–∏–Ω–∞–ª –∏ –ø–µ—Ä–µ—Ö–æ–∂—É –≤ –ø–∞–ø–∫—É `cd C:\Users\erohi\Desktop\de_project`

–ö–ª–æ–Ω–∏—Ä—É—é —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π `git clone git@github.com:erohin94/pet_project_earthquake.git`

<img width="1237" height="546" alt="image" src="https://github.com/user-attachments/assets/500dd782-ab81-4b35-9b6b-e4dc7cf02b85" />

<img width="763" height="147" alt="image" src="https://github.com/user-attachments/assets/30ff7da1-1f9b-4986-9f20-86327b918f0d" />

–í–∏–¥–∏–º –∫–∞–∫ —É–¥–∞–ª–µ–Ω–Ω—ã–π—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —Å–∫–ª–æ–Ω–∏—Ä–æ–≤–∞–ª—Å—è –≤ –ª–æ–∫–∞–ª—å–Ω—É—é –ø–∞–ø–∫—É.

<img width="621" height="154" alt="image" src="https://github.com/user-attachments/assets/c99a0e74-63de-4994-ba95-3ffe80795ded" />

## –ü—Ä–æ–≤–µ—Ä—è—é —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∏ —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è.

–ü—Ä–æ–≤–µ—Ä—è—é –≤–µ—Ä—Å–∏—é git `git --version`

<img width="386" height="32" alt="image" src="https://github.com/user-attachments/assets/00827df4-81f2-43e4-bbb3-927eba29df32" />

–ó–∞–¥–∞—é –∏–º—è –ø–æ–ª—å–∑–ª–≤–∞—Ç–µ–ª—è –∏ –ø–æ—á—Ç—É, –¥–∞–ª–µ–µ –¥–µ–ª–∞—é –ø—Ä–æ–≤–µ—Ä–∫—É

```
git config --global user.name "–í–∞—à–µ –∏–º—è"
git config --global user.email "email@domain.com"

git config user.email
git config user.name
```

<img width="686" height="147" alt="image" src="https://github.com/user-attachments/assets/4d228749-c507-49b3-8577-66253c14aadd" />

–°–æ–∑–¥–∞—é –ª–æ–∫–∞–ª—å–Ω–æ —Ç–µ—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª `test_file.txt`

<img width="622" height="194" alt="image" src="https://github.com/user-attachments/assets/18dfb0b7-1585-4962-a24c-7dc0822c5f35" />

–ü—Ä–æ–±—É—é –µ–≥–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ —É–¥–∞–ª–µ–Ω–Ω—ã–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π, –Ω–æ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π, –µ—Å–ª–∏ –≤ —É–¥–∞–ª–µ–Ω–Ω–æ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –±—ã–ª–∏ –∫–∞–∫–∏–µ –ª–∏–±–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è, –∏—Ö –Ω–∞–¥–æ —Å–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤–∏—Ç—å –≤ –ª–æ–∫–∞–ª—å–Ω—ã–π.

–°–Ω–∞—á–∞–ª–∞ –ø–æ–¥—Ç—è–≥–∏–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å —É–¥–∞–ª—ë–Ω–Ω–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è: `git pull origin main`

<img width="700" height="213" alt="image" src="https://github.com/user-attachments/assets/ffc16e18-8199-4317-85a8-18617b338261" />

–î–æ–±–∞–≤–∏—Ç—å —Ñ–∞–π–ª—ã: `git add .`

–°–¥–µ–ª–∞—Ç—å –∫–æ–º–º–∏—Ç: `git commit -m "–¢–µ—Å—Ç–æ–≤—ã–π –∫–æ–º–º–∏—Ç"`

<img width="737" height="101" alt="image" src="https://github.com/user-attachments/assets/c3c46477-aa5b-43da-9974-e1c46a848d0d" />

–ó–∞—Ç–µ–º –ø—É—à–∏–º: `git push origin main`

<img width="617" height="165" alt="image" src="https://github.com/user-attachments/assets/a6e44861-6c3b-40de-b3b0-f2eafbeda88b" />

–ö–∞–∫ –≤–∏–¥–∏–º, —Ñ–∞–π–ª –¥–æ–±–∞–≤–ª–µ–Ω –≤ —É–¥–∞–ª–µ–Ω–Ω—ã–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π.

<img width="1309" height="396" alt="image" src="https://github.com/user-attachments/assets/6776b1a3-feeb-4a0c-9d96-140827d946a6" />

## –°–æ–∑–¥–∞–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–û—Ç–∫—Ä—ã–≤–∞—é VS Code –∏ —Å–æ–∑–¥–∞—é –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ: `python -m venv venv`

–ê–∫—Ç–∏–≤–∏—Ä—É—é –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ: `venv\Scripts\activate`

<img width="851" height="181" alt="image" src="https://github.com/user-attachments/assets/96c9049f-54cf-45c4-9f53-ef8511eac1e9" />

–ö–∞–∫ –≤–∏–¥–Ω–æ, –Ω–∞ —Ç–µ–∫—É—â–∏–π –º–æ–º–µ–Ω—Ç –∞–±—Å–æ–ª—é—Ç–Ω–æ –ø—É—Å—Ç–æ–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ

<img width="578" height="88" alt="image" src="https://github.com/user-attachments/assets/e66c1507-8288-405d-a62d-294075f94a8c" />

## –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–µ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã

–í services –≤ .yaml —Ñ–∞–π–ª–µ –±—ã–ª–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã —Å–µ—Ä–≤–∏—Å—ã postgres_dwh, minio, metabase

–¢–∞–∫ –∂–µ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é `_PIP_ADDITIONAL_REQUIREMENTS: ${_PIP_ADDITIONAL_REQUIREMENTS:-duckdb}` –±—ã–ª –¥–æ–±–∞–≤–ª–µ–Ω `duckdb`. –ü–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è –¥–∞–ª–µ–µ. –ë–µ–∑ –Ω–µ–≥–æ –±—É–¥–µ—Ç –æ—à–∏–±–∫–∞ –≤ UI Airflow.

<img width="803" height="260" alt="image" src="https://github.com/user-attachments/assets/b452b61d-e789-4a37-b8e1-3cc94eeb8525" />

–í–æ–∑–Ω–∏–∫–∞–µ—Ç –∏–∑ –∑–∞ —Ç–æ–≥–æ —á—Ç–æ, —É –º–µ–Ω—è Airflow –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ –æ–Ω –Ω–µ –∑–Ω–∞–µ—Ç –æ –º–æ–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–º –æ–∫—Ä—É–∂–µ–Ω–∏–∏ venv, –∏ —Ç–æ —á—Ç–æ —è —É—Å—Ç–∞–Ω–≤–∞–ª–∏–≤–∞—é –≤ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ venv, –Ω–∞–ø—Ä–∏–º–µ—Ä —É—Å—Ç–∞–Ω–æ–≤–∏–ª –≤ venv –º–æ–¥—É–ª—å duckdb (–¥–∞–ª–µ–µ –±—É–¥–µ—Ç –æ–ø–∏—Å–∞–Ω–æ –ø—Ä–æ —É—Å—Ç–∞–Ω–æ–≤–∫—É).
Airflow –≤ –¥–æ–∫—Ä–µ –Ω–µ –∑–Ω–∞–µ—Ç –æ–± —ç—Ç–æ–º, –ø–æ—ç—Ç–æ–º—É –Ω–∞–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–æ–ø–∏—Å–∞—Ç—å –≤ `_PIP_ADDITIONAL_REQUIREMENTS: ${_PIP_ADDITIONAL_REQUIREMENTS:-duckdb}` –≤—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏, –∫–æ—Ç–æ—Ä—ã–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞. –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ DAG –∏ –∑–∞–¥–∞—á–∏ —Å–º–æ–≥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –ø–∞–∫–µ—Ç—ã –±–µ–∑ –æ—à–∏–±–æ–∫ –∏–º–ø–æ—Ä—Ç–∞.  

–í—ã–ø–æ–ª–Ω—è—é –∫–æ–º–∞–Ω–¥—É: `docker-compose up -d`

–ü—Ä–æ–≤–µ—Ä—è—é: `docker ps`

–ö–∞–∫ –≤–∏–¥–Ω–æ —Å–µ—Ä–≤–∏—Å—ã —Å—Ç–∞—Ä—Ç–∞–Ω—É–ª–∏

<img width="1862" height="208" alt="image" src="https://github.com/user-attachments/assets/2bd9ee89-f7f5-4178-872d-d980e7153c9e" />

–í –ª–æ–∫–∞–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –±—ã–ª–∏ —Å–æ–∑–¥–∞–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–∞–ø–∫–∏: dags, logs –∏ —Ç–¥

<img width="623" height="359" alt="image" src="https://github.com/user-attachments/assets/8a61e056-80d2-4ae2-af6e-af4597c5c76d" />

## –ó–∞–ø—É—Å–∫ Airflow

–ß—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å Airflow, –æ—Ç–∫—Ä—ã—Ç—å –±—Ä–∞—É–∑–µ—Ä –∏ –ø–µ—Ä–µ–π—Ç–∏ –ø–æ –∞–¥—Ä–µ—Å—É http://127.0.0.1:8080/

–ï—Å–ª–∏ –≤—Å–µ –ø—Ä–æ—à–ª–æ –ø–æ –ø–ª–∞–Ω—É, —Ç–æ –ø–æ—è–≤–∏—Ç—Å—è –æ–∫–Ω–æ –¥–ª—è –≤–≤–æ–¥–∞ –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø–∞—Ä–æ–ª—è. –í–≤–æ–¥–∏–º –≤ –æ–±–∞ –æ–∫–æ—à–∫–∞ airflow –∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ–º.

<img width="1898" height="372" alt="image" src="https://github.com/user-attachments/assets/8d3ef726-4098-4459-b222-6ad2679aac5d" />

## –ó–∞–ø—É—Å–∫ Minio

–ß—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å Minio, –æ—Ç–∫—Ä—ã—Ç—å –±—Ä–∞—É–∑–µ—Ä –∏ –ø–µ—Ä–µ–π—Ç–∏ –ø–æ –∞–¥—Ä–µ—Å—É http://127.0.0.1:9001

–í–æ–π—Ç–∏ –≤ UI –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å —É—á–µ—Ç–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –í–≤–æ–¥–∏–º –≤ –æ–±–∞ –æ–∫–æ—à–∫–∞ minioadmin

<img width="1890" height="336" alt="image" src="https://github.com/user-attachments/assets/f542816e-7023-45d4-8104-f4564298369d" />

–°–æ–∑–¥–∞–µ–º –±–∞–∫–µ—Ç

<img width="1893" height="660" alt="image" src="https://github.com/user-attachments/assets/4dc88c72-208b-4994-97d3-6531fe937c48" />

–°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–ª—é—á–∏ –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∫–µ—Ç—É.

<img width="1893" height="792" alt="image" src="https://github.com/user-attachments/assets/f0d49609-bf00-4a04-8e3c-97491255fa52" />

<img width="1156" height="646" alt="image" src="https://github.com/user-attachments/assets/b0dc8851-2884-4f23-87bb-1c27b6c9111a" />

–°–æ–∑–¥–∞—é —Ñ–∞–π–ª–∏–∫ cred.py –≤ –∫–æ—Ç–æ—Ä–æ–º –±—É–¥—É—Ç –∫–ª—é—á–∏. –í –≥–∏—Ç —Ö—Ä–∞–Ω–∏—Ç—å –µ–≥–æ –Ω–µ –±—É–¥–µ–º.

<img width="938" height="389" alt="image" src="https://github.com/user-attachments/assets/20401d17-14f0-4e5c-bd94-602122ade746" />

–í —Ä–∞–º–∫–∞—Ö S3 access –∫–ª—é—á –º–æ–∂–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –∏ –æ–Ω –Ω–∏–∫–∞–∫ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ —Å–µ–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–ª—é—á–∞.

–í data —É –Ω–∞—Å —Å–µ–π—á–∞—Å –Ω–∞—á–∞–ª–∏ –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å—Å—è –º–µ—Ç–∞ —Ñ–∞–π–ª—ã, –µ–≥–æ –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –Ω–µ –±—É–¥–µ–º, –ø–æ—ç—Ç–æ–º—É –¥–æ–±–∞–≤–∏–º –≤ .gitignore

–û—Ç–∫—Ä—ã–≤–∞—é .gitignore –∏ –≤ –∫–æ–Ω—Ü–µ –ø—Ä–æ–ø–∏—Å—ã–≤–∞—é

```
#Project
data/
logs/
cred.py
```

–≠—Ç–∏ —Ñ–∞–π–ª—ã —Ç–µ–ø–µ—Ä—å –Ω–µ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –≤ —É–¥–∞–ª–µ–Ω–Ω—ã–π —Ä–µ–ø–æ –Ω–∞ –≥–∏—Ç—Ö–∞–±

## –ó–∞–ø—É—Å–∫ Metabase

Metabase: http://localhost:3000

## –°–æ–∑–¥–∞–Ω–∏–µ –ø–µ—Ä–≤–æ–≥–æ DAG

–ü–µ—Ä–≤—ã–π –¥–∞–≥ –±—É–¥–µ—Ç –≥—Ä—É–∑–∏—Ç—å —Å—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ API –∏ —Å–∫–ª–∞–¥—ã–≤–∞—Ç—å –≤ S3 `raw_from_api_to_s3.py`

Airflow —Å–µ–π—á–∞—Å —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –¥–æ–∫–µ—Ä–µ, —É –¥–æ–∫–µ—Ä–∞ –µ—Å—Ç—å —Å–≤–æ–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –∫–æ—Ç–æ—Ä–æ–µ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–æ –æ—Ç –º–æ–µ–≥–æ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∫–æ–º–ø—å—é—Ç–µ—Ä–∞.

–í –º–æ–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–º –æ–∫—Ä—É–∂–µ–Ω–∏–∏ venv —Å–µ–π—á–∞—Å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —Ç–æ–ª—å–∫–æ pip.

–ß—Ç–æ–±—ã —Å—Ä–∞–≤–Ω—è—Ç—å –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –º–µ–∂–¥—É Airflow –∏ –º–æ–µ–π –ª–æ–∫–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω–æ–π, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–∫–∞—á–∞—Ç—å –ø–∞–∫–µ—Ç –≤ –º–æ–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –∫–æ—Ç–æ—Ä–æ–µ –∑–∞–ø—É—â–µ–Ω–æ –≤ VsCode.

–ü—Ä–æ–ø–∏—Å—ã–≤–∞—é –≤ –ø–æ–∏—Å–∫–æ–≤–∏–∫–µ pipy apache airflow –∏ —Å–∫–∞—á–∏–≤–∞—é –≤–µ—Ä—Å–∏—é 2.10.5 [—Å—Å—ã–ª–∫–∞](https://pypi.org/project/apache-airflow/#history)

<img width="584" height="99" alt="image" src="https://github.com/user-attachments/assets/608ba9d6-5004-45ba-a5ff-38dc7c257d17" />

–ï—Å–ª–∏ —Å–µ—á–∞—Å –≤ .py —Ñ–∞–π–ª–µ –ø—Ä–æ–ø–∏—Å–∞—Ç—å `from airflow import DAG`, —Ç–æ —É–≤–∏–¥–∏–º –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏–µ

<img width="203" height="26" alt="image" src="https://github.com/user-attachments/assets/d03e4540-5d18-48d3-9900-417c6832d1c2" />

–≠—Ç–æ –≥–æ–≤–æ—Ä–∏—Ç –æ —Ç–æ–º —á—Ç–æ –¥–∞–Ω–Ω–æ–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –Ω–µ –∑–Ω–∞–µ—Ç —á—Ç–æ —Ç–∞–∫–æ–µ Airflow –∏ —á—Ç–æ —Ç–∞–∫–æ–µ DAG. 

–î–ª—è —ç—Ç–æ–≥–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º: `pip install apache-airflow==2.10.5` –≤ –Ω–∞—à–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ.

–¢–µ–ø–µ—Ä—å –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏, –µ—Å–ª–∏ –≤—ã–¥–µ–ª–∏—Ç—å DAG –≤ –∏–º–ø–æ—Ä—Ç–µ –∏ –Ω–∞–∂–∞—Ç—å CTRL —Ç–æ –±—É–¥–µ—Ç –≤–∏–¥–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è.

<img width="825" height="322" alt="image" src="https://github.com/user-attachments/assets/86218e23-0c7a-44b0-ac27-3e1b409e2674" />

–¢–∞–∫ –∂–µ –º–æ–∂–Ω–æ –∏ –ø—Ä–æ–≤–∞–ª–∏—Ç—Å—è –≤ airflow.

*(–ò–∑–Ω–∞—á–∞–ª—å–Ω–æ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –Ω–∞ DAG, –Ω–µ —É–¥–∞–≤–∞–ª–æ—Å—å –≤–∏–¥–µ—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é, —Ç–∞–∫ –∫–∞–∫ –≤ VS‚ÄØCode –Ω–µ –±—ã–ª –≤—ã–±—Ä–∞–Ω –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ç–æ—Ä Python –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞.
–ò–∑-–∑–∞ —ç—Ç–æ–≥–æ Pylance –∏ Intellisense –ø–æ–∫–∞–∑—ã–≤–∞–ª–∏ Any, –ø–æ—Ç–æ–º—É —á—Ç–æ –æ–Ω–∏ –Ω–µ –≤–∏–¥–µ–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –ø–∞–∫–µ—Ç—ã –≤ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–º –æ–∫—Ä—É–∂–µ–Ω–∏–∏.
–ü–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ç–æ—Ä–∞ Python (–≤ –º–æ—ë–º —Å–ª—É—á–∞–µ venv –ø—Ä–æ–µ–∫—Ç–∞) –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –∏ docstring –¥–ª—è DAG –Ω–∞—á–∞–ª–∏ —Ä–∞–±–æ—Ç–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.)*

–¢–∞–∫ –∂–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é duckdb [—Å—Å—ã–ª–∫–∞](https://pypi.org/project/duckdb/1.2.2/)

–°—Ç–∞–≤–ª—é –≤–µ—Ä—Å–∏—é: `pip install duckdb==1.2.2`

–ü–∏—à—É –∫–æ–¥ –≤ `raw_from_api_to_s3.py`

```
import logging

import duckdb
import pendulum # –î–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–∞—Ç–∞–º–∏
from airflow import DAG
from airflow.models import Variable
from airflow.operators.empty import EmptyOperator
from airflow.operators.python import PythonOperator

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è DAG
OWNER = "e.erokhin"
DAG_ID = "raw_from_api_to_s3"

# –ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Ç–∞–±–ª–∏—Ü—ã –≤ DAG
LAYER = "raw"
SOURCE = "earthquake"

# S3
ACCESS_KEY = Variable.get("access_key")
SECRET_KEY = Variable.get("secret_key")

LONG_DESCRIPTION = """
# LONG DESCRIPTION
"""

SHORT_DESCRIPTION = "SHORT DESCRIPTION"

args = {
    "owner": OWNER,
    "start_date": pendulum.datetime(2025, 11, 12, tz="Europe/Moscow"),
    "catchup": True,
    "retries": 3,
    "retry_delay": pendulum.duration(hours=1),
}


def get_dates(**context) -> tuple[str, str]:
    """"""
    start_date = context["data_interval_start"].format("YYYY-MM-DD")
    end_date = context["data_interval_end"].format("YYYY-MM-DD")

    return start_date, end_date


def get_and_transfer_api_data_to_s3(**context):
    """"""

    start_date, end_date = get_dates(**context)
    logging.info(f"üíª Start load for dates: {start_date}/{end_date}")
    con = duckdb.connect()

    #con.sql(
        #f"""
        #SET TIMEZONE='UTC';
        #INSTALL httpfs;
        #LOAD httpfs;
        #SET s3_url_style = 'path';
        #SET s3_endpoint = 'minio:9000';
        #SET s3_access_key_id = '{ACCESS_KEY}'; 
        #SET s3_secret_access_key = '{SECRET_KEY}';
        #SET s3_use_ssl = FALSE;

        #COPY
        #(
            #SELECT
                #*
            #FROM
                #read_csv_auto('https://earthquake.usgs.gov/fdsnws/event/1/query?format=csv&starttime={start_date}&endtime={end_date}') AS res
        #) TO 's3://prod/{LAYER}/{SOURCE}/{start_date}/{start_date}_00-00-00.gz.parquet';

       #""",
    #)
    con.sql(
    f"""
    SET TIMEZONE='UTC';
    INSTALL httpfs;
    LOAD httpfs;

    SET s3_url_style='path';
    SET s3_endpoint='minio:9000';
    SET s3_access_key_id='{ACCESS_KEY}';
    SET s3_secret_access_key='{SECRET_KEY}';
    SET s3_use_ssl=FALSE;

    COPY (
        SELECT *
        FROM read_csv_auto(
            'https://earthquake.usgs.gov/fdsnws/event/1/query?format=csv&starttime={start_date}&endtime={end_date}'
        )
    ) TO 's3://prod/{LAYER}/{SOURCE}/{start_date}/{start_date}_00-00-00.gz.parquet'
    (FORMAT PARQUET, COMPRESSION 'GZIP');
    """
)
    con.close()
    logging.info(f"‚úÖ Download for date success: {start_date}")


with DAG(
    dag_id=DAG_ID,
    schedule_interval="0 5 * * *",
    default_args=args,
    tags=["s3", "raw"],
    description=SHORT_DESCRIPTION,
    concurrency=1,
    max_active_tasks=1,
    max_active_runs=1,
) as dag:
    dag.doc_md = LONG_DESCRIPTION

    start = EmptyOperator(
        task_id="start",
    )

    get_and_transfer_api_data_to_s3 = PythonOperator(
        task_id="get_and_transfer_api_data_to_s3",
        python_callable=get_and_transfer_api_data_to_s3,
    )

    end = EmptyOperator(
        task_id="end",
    )

    start >> get_and_transfer_api_data_to_s3 >> end
```

–ü–æ—Å–ª–µ —á–µ–≥–æ –æ–±–Ω–æ–≤–ª—è—é UI Airflow –∏ –≤–∏–∂—É –æ—à–∏–±–∫—É:

<img width="814" height="295" alt="image" src="https://github.com/user-attachments/assets/365e0846-1f98-42cc-ab2e-1172198bad64" />

–†—É–≥–∞–µ—Ç—Å—è –Ω–∞ —Ç–æ, —á—Ç–æ –∫–ª—é—á–µ–π –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç. –î–ª—è —ç—Ç–æ–≥–æ –ø–µ—Ä–µ—Ö–æ–∂—É –≤ Admin->Variables –∏ —Å–æ–∑–¥–∞—é –Ω–æ–≤—ã–π –∞—Ç—Ä–∏–±—É—Ç:

<img width="780" height="444" alt="image" src="https://github.com/user-attachments/assets/0015274f-3e05-4e0b-8bc4-74d5ed3b2d6e" />

<img width="853" height="463" alt="image" src="https://github.com/user-attachments/assets/2653454e-64e8-4765-8fea-fd9a7b4a6a5f" />

<img width="1391" height="527" alt="image" src="https://github.com/user-attachments/assets/e30782a9-05b6-41c7-99eb-7eb10b2a44bc" />

–û–±–Ω–æ–≤–ª—è—é –∏ –≤–∏–∂—É —á—Ç–æ –ø–æ—è–≤–∏–ª—Å—è –¥–∞–≥ –∏ –ø—Ä–æ–ø–∞–ª–∞ –æ—à–∏–±–∫–∞

<img width="1889" height="402" alt="image" src="https://github.com/user-attachments/assets/35d482a3-1085-4609-aa85-1389a612fbf2" />

44:00
